
# root is the faction member
fe_calculate_faction_desire = {
	set_variable = { name = fe_faction_total_desire value = 0 }
	set_variable = { name = fe_base_reluctance value = 0 }
	set_variable = { name = fe_opinion_of_target value = 0 }
	set_variable = { name = fe_different_faith value = 0 }
	set_variable = { name = fe_legalism_virtues value = 0 }
	set_variable = { name = fe_legalism_sins value = 0 }
	set_variable = { name = fe_intimidated value = 0 }
	set_variable = { name = fe_target_debt value = 0 }
	set_variable = { name = fe_game_difficulty_score value = 0 }
	set_variable = { name = fe_game_stability_score value = 0 }
	set_variable = { name = fe_same_faith_elector_score value = 0 }
	set_variable = { name = fe_not_de_jure_score value = 0 }
	set_variable = { name = fe_rank_score value = 0 }
	set_variable = { name = fe_grandeur_score value = 0 }

	if = {
		limit = {
			joined_faction = {
				faction_is_type = independence_faction
			}
		}

		change_variable = {
			name = fe_base_reluctance
			add = -150
		}

		fe_calculate_opinion_modifier = {
			OPINION_MULTIPLIER = -0.4
			MAX_OPINION = 100
		}

		fe_independence_faction_modifiers = {
			TARGET = root.joined_faction.faction_target
		}
	}

	if = {
		limit = {
			joined_faction = {
				faction_is_type = liberty_faction
			}
		}

		change_variable = {
			name = fe_base_reluctance
			add = 0
		}

		fe_calculate_opinion_modifier = {
			OPINION_MULTIPLIER = -1
			MAX_OPINION = 0
		}
	}

	if = {
		limit = {
			joined_faction = {
				faction_is_type = claimant_faction
			}
		}

		change_variable = {
			name = fe_base_reluctance
			add = -25
		}

		fe_calculate_opinion_modifier = {
			OPINION_MULTIPLIER = -1
			MAX_OPINION = 100
		}
	}

	if = {
		limit = {
			joined_faction = {
				OR = {
					faction_is_type = independence_faction
					faction_is_type = liberty_faction
					faction_is_type = claimant_faction
				}
			}
		}

		fe_calculate_faith_modifier = {
			ASTRAY_BASE_VALUE = 25
			HOSTILE_BASE_VALUE = 50
			EVIL_BASE_VALUE = 100
			TARGET_FAITH = root.joined_faction.faction_target.faith
		
}
		fe_calculate_debt = {
			TARGET = root.joined_faction.faction_target
			SCORE_PER_DEBT_LEVEL = 10
		}

		fe_calculate_game_settings = {
			VERY_EASY_DIFFICULTY = -150
			EASY_DIFFICULTY = -50
			LESSER_STABILITY = 50
			HIGHER_STABILITY = -50
			EXTREME_STABILITY = -100
		}
	}

	if = {
		limit = {
			joined_faction = {
				faction_is_type = populist_faction
			}
		}

		change_variable = {
			name = fe_base_reluctance
			add = -25
		}

		fe_calculate_opinion_modifier = {
			OPINION_MULTIPLIER = -1
			MAX_OPINION = 100
		}

		fe_calculate_faith_modifier = {
			ASTRAY_BASE_VALUE = 35
			HOSTILE_BASE_VALUE = 75
			EVIL_BASE_VALUE = 125
			TARGET_FAITH = root.joined_faction.faction_target.faith
		}

		fe_calculate_debt = {
			TARGET = root.joined_faction.faction_target
			SCORE_PER_DEBT_LEVEL = 20
		}

		fe_calculate_game_settings = {
			VERY_EASY_DIFFICULTY = 0
			EASY_DIFFICULTY = 0
			LESSER_STABILITY = 25
			HIGHER_STABILITY = -50
			EXTREME_STABILITY = -100
		}

	}

	fe_legalism_virtue_and_sin = {
		SCORE_PER_TRAIT = 25
		TARGET = root.joined_faction.faction_target
	}

	fe_intimidated = {
		POWER = root.joined_faction.faction_power
		THRESHOLD = root.joined_faction.faction_power_threshold
	}

	change_variable = {
		name = fe_faction_total_desire
		add = var:fe_base_reluctance
	}
	change_variable = {
		name = fe_faction_total_desire
		add = var:fe_opinion_of_target
	}
	change_variable = {
		name = fe_faction_total_desire
		add = var:fe_different_faith
	}
	change_variable = {
		name = fe_faction_total_desire
		add = var:fe_legalism_virtues
	}
	change_variable = {
		name = fe_faction_total_desire
		add = var:fe_legalism_sins
	}
	change_variable = {
		name = fe_faction_total_desire
		add = var:fe_intimidated
	}
	change_variable = {
		name = fe_faction_total_desire
		add = var:fe_target_debt
	}
	change_variable = {
		name = fe_faction_total_desire
		add = var:fe_game_difficulty_score
	}
	change_variable = {
		name = fe_faction_total_desire
		add = var:fe_game_stability_score
	}
	change_variable = {
		name = fe_faction_total_desire
		add = var:fe_same_faith_elector_score
	}
	change_variable = {
		name = fe_faction_total_desire
		add = var:fe_not_de_jure_score
	}
	change_variable = {
		name = fe_faction_total_desire
		add = var:fe_rank_score
	}
	change_variable = {
		name = fe_faction_total_desire
		add = var:fe_grandeur_score
	}
}

# root is the faction member
# modifies fe_opinion_of_target
# handles the >=80 opinion cutoff too
fe_calculate_opinion_modifier = {
	save_temporary_opinion_value_as = {
		name = fe_temp_opinion
		target = joined_faction.faction_target
	}
	# need to make it a real variable
	set_variable = {
		name = fe_temp1
		value = scope:fe_temp_opinion
	}

	if = {
		limit = { var:fe_temp1 >= 80 }
		change_variable = {
			name = fe_opinion_of_target
			add = -1000
		}
	}

	if = {
		limit = { var:fe_temp1 > $MAX_OPINION$ }
		set_variable = {
			name = fe_temp1
			value = $MAX_OPINION$
		}
	}

	change_variable = {
		name = fe_temp1
		multiply = $OPINION_MULTIPLIER$
	}

	change_variable = {
		name = fe_opinion_of_target
		add = var:fe_temp1
	}

	remove_variable = fe_temp1
}

# root is the faction member
# sets fe_different_faith
# emulates pluralism_fundamentalism_modifier
fe_calculate_faith_modifier = {
	if = {
		limit = {
			root.culture = {
				has_cultural_parameter = doesnt_care_about_culture_faith_in_factions
			}
		}
		# no effect, fe_different_faith stays at 0
	}
	else_if = {
		limit = {
			root.faith = {
				faith_hostility_level = {
					target = $TARGET_FAITH$
					value = faith_astray_level
				}
			}
		}

		set_variable = {
			name = fe_different_faith
			value = $ASTRAY_BASE_VALUE$
		}
	}
	else_if = {
		limit = {
			root.faith = {
				faith_hostility_level = {
					target = $TARGET_FAITH$
					value = faith_hostile_level
				}
			}
		}

		set_variable = {
			name = fe_different_faith
			value = $HOSTILE_BASE_VALUE$
		}
	}
	else_if = {
		limit = {
			root.faith = {
				faith_hostility_level = {
					target = $TARGET_FAITH$
					value = faith_evil_level
				}
			}
		}

		set_variable = {
			name = fe_different_faith
			value = $EVIL_BASE_VALUE$
		}
	}

	# modify for target's faith's righteousness
	if = {
		limit = {
			$TARGET_FAITH$ = {
				has_doctrine = doctrine_pluralism_righteous
			}
		}
		change_variable = {
			name = fe_different_faith
			multiply = hostility_multiplier_righteous
		}
	}
	else_if = {
		limit = {
			$TARGET_FAITH$ = {
				has_doctrine = doctrine_pluralism_pluralistic
			}
		}
		change_variable = {
			name = fe_different_faith
			multiply = hostility_multiplier_pluralism
		}
	}
	else_if = {
		limit = {
			$TARGET_FAITH$ = {
				has_doctrine = doctrine_pluralism_fundamentalist
			}
		}
		change_variable = {
			name = fe_different_faith
			multiply = hostility_multiplier_fundamentalist
		}
	}

	if = {
		limit = {
			$TARGET_FAITH$ = {
				has_doctrine_parameter = reduced_vassal_religion_discontent
			}
			var:fe_different_faith > 0
		}
		set_variable = {
			name = fe_temp2
			value = $ASTRAY_BASE_VALUE$
		}
		change_variable = {
			name = fe_temp2
			multiply = hostility_multiplier_reduction_adaptive
		}
		change_variable = {
			name = fe_different_faith
			add = var:fe_temp2
		}
		remove_variable = fe_temp2
	}
}

# root is the faction member
# modifies fe_legalism_virtues and fe_legalism_sins
# inputs: SCORE_PER_TRAIT and TARGET
fe_legalism_virtue_and_sin = {
	if = {
		limit = {
			$TARGET$.faith = {
				has_doctrine_parameter = legalism_reduced_faction_virtues
			}
		}
		change_variable = {
			name = fe_legalism_virtues
                        subtract = $SCORE_PER_TRAIT$
		}
		change_variable = {
			name = fe_legalism_virtues
                        multiply = $TARGET$.num_virtuous_traits
		}
		if = {
			limit = {
				$TARGET$ = {
					has_trait = zealous
				}
			}
			change_variable = {
				name = fe_legalism_virtues
				multiply = 2
			}
		}
		if = {
			limit = {
				$TARGET$ = {
					has_trait = cynical
				}
			}
			change_variable = {
				name = fe_legalism_virtues
				multiply = 0.5
			}
		}
	}

	if = {
		limit = {
			$TARGET$.faith = {
				has_doctrine_parameter = legalism_reduced_faction_virtues
			}
		}
		change_variable = {
			name = fe_legalism_sins
                        add = $SCORE_PER_TRAIT$
		}
		change_variable = {
			name = fe_legalism_sins
                        multiply = $TARGET$.num_sinful_traits
		}
		if = {
			limit = {
				$TARGET$ = {
					has_trait = zealous
				}
			}
			change_variable = {
				name = fe_legalism_sins
				multiply = 2
			}
		}
		if = {
			limit = {
				$TARGET$ = {
					has_trait = cynical
				}
			}
			change_variable = {
				name = fe_legalism_sins
				multiply = 0.5
			}
		}
	}
}

fe_intimidated = {
	if = {
		limit = {
			has_dread_level_towards = {
				target = root.joined_faction.faction_target
				level = 1
			}
			$POWER$ < $THRESHOLD$
		}
		change_variable = {
			name = fe_intimidated
			add = -50
		}
	}

	if = {
		limit = {
			has_dread_level_towards = {
				target = root.joined_faction.faction_target
				level = 2
			}
		}
		if = {
			limit = {
				$POWER$ < $THRESHOLD$
			}
			change_variable = {
				name = fe_intimidated
				add = -1000
			}
		}
		else = {
			change_variable = {
				name = fe_intimidated
				add = -100
			}

		}
	}
}

# root is the faction member
# inputs: TARGET SCORE_PER_DEBT_LEVEL
# modifies fe_target_debt
fe_calculate_debt = {
	if = {
		limit = {
			$TARGET$ = { gold <= 0 }
		}
		set_variable = {
			name = fe_temp3
			value = $TARGET$.debt_level
		}
		change_variable = {
			name = fe_temp3
			add = 1
		}
		if = {
			limit = { $TARGET$ = { debt_level > 9 } }
			set_variable = {
				name = fe_temp3
				value = 10
			}
		}
		change_variable = {
			name = fe_temp3
			multiply = $SCORE_PER_DEBT_LEVEL$
		}
		change_variable = {
			name = fe_target_debt
			add = var:fe_temp3
		}
		remove_variable = fe_temp3
	}
}

# root is faction member
# modifies fe_game_difficulty and fe_game_stability_score
fe_calculate_game_settings = {
	if = {
		limit = {
			has_game_rule = very_easy_difficulty
			root.joined_faction.faction_target = {
				is_ai = no
			}
		}
		change_variable = {
			name = fe_game_difficulty_score
			add = $VERY_EASY_DIFFICULTY$
		}
	}
	if = {
		limit = {
			has_game_rule = easy_difficulty
			root.joined_faction.faction_target = {
				is_ai = no
			}
		}
		change_variable = {
			name = fe_game_difficulty_score
			add = $EASY_DIFFICULTY$
		}
	}
	if = {
		limit = { has_game_rule = lesser_realm_stability }
		change_variable = {
			name = fe_game_stability_score 
			add = $LESSER_STABILITY$
		}
	}
	if = {
		limit = { has_game_rule = higher_realm_stability }
		change_variable = {
			name = fe_game_stability_score 
			add = $HIGHER_STABILITY$
		}
	}
	if = {
		limit = { has_game_rule = extreme_realm_stability }
		change_variable = {
			name = fe_game_stability_score 
			add = $EXTREME_STABILITY$
		}
	}
}

fe_independence_faction_modifiers = {
	if = {
		limit = {
			$TARGET$.primary_title = {
				has_order_of_succession = election
				any_elector = {
					this = root
				}
			}
			$TARGET$.faith = root.faith
		}
		change_variable = {
			name = fe_same_faith_elector_score
			add = -150
		}
	}

	if = {
		limit = {
			OR = {
				NOT = {
					is_rightful_liege_of_trigger = {
						VASSAL = root
						LIEGE = $TARGET$
					}
				}
				any_sub_realm_county = {
					percent <= 0.5
					save_temporary_scope_as = current_county
					$TARGET$.primary_title = {
						any_in_de_jure_hierarchy = {
							this = scope:current_county
						}
					}
				}
			}
		}

		change_variable = {
			name = fe_not_de_jure_score
			add = 125
		}
		change_variable = {
			name = fe_not_de_jure_score
			add = {
				value = sub_realm_size
				multiply = 2
			}
		}
	}

	if = {
		limit = { highest_held_title_tier = tier_kingdom }
		change_variable = {
			name = fe_rank_score
			add = 50
		}

		if = {
			limit = {
				has_royal_court = yes
				$TARGET$ = { has_royal_court = yes }
				court_grandeur_current_level > $TARGET$.court_grandeur_current_level
			}
			change_variable = {
				name = fe_grandeur_score
				add = {
					add = court_grandeur_current_level
					subtract = $TARGET$.court_grandeur_current_level
					multiply = 15
				}
			}
		}
	}

	if = {
		limit = { highest_held_title_tier = tier_county }
		change_variable = {
			name = fe_rank_score
			add = -25
		}
	}
}
