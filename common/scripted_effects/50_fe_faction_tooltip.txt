
# root is the faction member
fe_calculate_faction_desire = {
	set_variable = {
		name = fe_faction_total_desire
		value = 0
	}

	set_variable = {
		name = fe_base_reluctance
		value = 0
	}

	set_variable = {
		name = fe_opinion_of_target
		value = 0
	}

	set_variable = {
		name = fe_different_faith
		value = 0
	}

	save_temporary_opinion_value_as = {
		name = target_opinion
		target = joined_faction.faction_target
	}

	if = {
		limit = {
			joined_faction = {
				faction_is_type = independence_faction
			}
		}

		change_variable = {
			name = fe_base_reluctance
			add = -150
		}

		fe_calculate_opinion_modifier = {
			OPINION_MULTIPLIER = -0.4
			MAX_OPINION = 100
		}
	}

	if = {
		limit = {
			joined_faction = {
				faction_is_type = liberty_faction
			}
		}

		change_variable = {
			name = fe_base_reluctance
			add = 0
		}

		fe_calculate_opinion_modifier = {
			OPINION_MULTIPLIER = -1
			MAX_OPINION = 0
		}
	}

	if = {
		limit = {
			joined_faction = {
				faction_is_type = claimant_faction
			}
		}

		change_variable = {
			name = fe_base_reluctance
			add = -25
		}

		fe_calculate_opinion_modifier = {
			OPINION_MULTIPLIER = -1
			MAX_OPINION = 100
		}
	}

	if = {
		limit = {
			joined_faction = {
				OR = {
					faction_is_type = independence_faction
					faction_is_type = liberty_faction
					faction_is_type = claimant_faction
				}
			}
		}

		fe_calculate_faith_modifier = {
			ASTRAY_BASE_VALUE = 25
			HOSTILE_BASE_VALUE = 50
			EVIL_BASE_VALUE = 100
			TARGET_FAITH = root.joined_faction.faction_target.faith
		}
	}

	if = {
		limit = {
			joined_faction = {
				faction_is_type = populist_faction
			}
		}

		change_variable = {
			name = fe_base_reluctance
			add = -25
		}

		fe_calculate_opinion_modifier = {
			OPINION_MULTIPLIER = -1
			MAX_OPINION = 100
		}

		fe_calculate_faith_modifier = {
			ASTRAY_BASE_VALUE = 35
			HOSTILE_BASE_VALUE = 75
			EVIL_BASE_VALUE = 125
			TARGET_FAITH = root.joined_faction.faction_target.faith
		}
	}

	change_variable = {
		name = fe_faction_total_desire
		add = var:fe_base_reluctance
	}
	change_variable = {
		name = fe_faction_total_desire
		add = var:fe_opinion_of_target
	}
	change_variable = {
		name = fe_faction_total_desire
		add = var:fe_different_faith
	}
}

# root is the faction member
# modifies fe_opinion_of_target
# handles the >=80 opinion cutoff too
fe_calculate_opinion_modifier = {
	save_temporary_opinion_value_as = {
		name = fe_temp_opinion
		target = joined_faction.faction_target
	}
	# need to make it a real variable
	set_variable = {
		name = fe_temp1
		value = scope:fe_temp_opinion
	}

	if = {
		limit = { var:fe_temp1 >= 80 }
		change_variable = {
			name = fe_opinion_of_target
			add = -1000
		}
	}

	if = {
		limit = { var:fe_temp1 > $MAX_OPINION$ }
		set_variable = {
			name = fe_temp1
			value = $MAX_OPINION$
		}
	}

	change_variable = {
		name = fe_temp1
		multiply = $OPINION_MULTIPLIER$
	}

	change_variable = {
		name = fe_opinion_of_target
		add = var:fe_temp1
	}

	remove_variable = fe_temp1
}

# root is the faction member
# sets fe_different_faith
# emulates pluralism_fundamentalism_modifier
fe_calculate_faith_modifier = {
	if = {
		limit = {
			root.culture = {
				has_cultural_parameter = doesnt_care_about_culture_faith_in_factions
			}
		}
		# no effect, fe_different_faith stays at 0
	}
	else_if = {
		limit = {
			root.faith = {
				faith_hostility_level = {
					target = $TARGET_FAITH$
					value = faith_astray_level
				}
			}
		}

		set_variable = {
			name = fe_different_faith
			value = $ASTRAY_BASE_VALUE$
		}
	}
	else_if = {
		limit = {
			root.faith = {
				faith_hostility_level = {
					target = $TARGET_FAITH$
					value = faith_hostile_level
				}
			}
		}

		set_variable = {
			name = fe_different_faith
			value = $HOSTILE_BASE_VALUE$
		}
	}
	else_if = {
		limit = {
			root.faith = {
				faith_hostility_level = {
					target = $TARGET_FAITH$
					value = faith_evil_level
				}
			}
		}

		set_variable = {
			name = fe_different_faith
			value = $EVIL_BASE_VALUE$
		}
	}

	# modify for target's faith's righteousness
	if = {
		limit = {
			$TARGET_FAITH$ = {
				has_doctrine = doctrine_pluralism_righteous
			}
		}
		change_variable = {
			name = fe_different_faith
			multiply = hostility_multiplier_righteous
		}
	}
	else_if = {
		limit = {
			$TARGET_FAITH$ = {
				has_doctrine = doctrine_pluralism_pluralistic
			}
		}
		change_variable = {
			name = fe_different_faith
			multiply = hostility_multiplier_pluralism
		}
	}
	else_if = {
		limit = {
			$TARGET_FAITH$ = {
				has_doctrine = doctrine_pluralism_fundamentalist
			}
		}
		change_variable = {
			name = fe_different_faith
			multiply = hostility_multiplier_fundamentalist
		}
	}

	if = {
		limit = {
			$TARGET_FAITH$ = {
				has_doctrine_parameter = reduced_vassal_religion_discontent
			}
			var:fe_different_faith > 0
		}
		set_variable = {
			name = fe_temp2
			value = $ASTRAY_BASE_VALUE$
		}
		change_variable = {
			name = fe_temp2
			multiply = hostility_multiplier_reduction_adaptive
		}
		change_variable = {
			name = fe_different_faith
			add = var:fe_temp2
		}
		remove_variable = fe_temp2
	}
}
